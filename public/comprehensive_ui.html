<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawl4AI Comprehensive Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="glass-effect shadow-lg mb-6 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="relative">
                        <i class="fas fa-spider text-blue-600 text-3xl mr-3"></i>
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full pulse-ring"></div>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold gradient-text">Crawl4AI</h1>
                        <p class="text-gray-600 text-sm">Comprehensive Feature Demo</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <button id="api-keys-btn" class="btn-secondary no-print"><i class="fas fa-key mr-1"></i>API Keys</button>
                        <button id="settings-btn" class="btn-secondary no-print"><i class="fas fa-cog mr-1"></i>Settings</button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="bg-gray-200 px-3 py-2 rounded-full flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2" id="connection-indicator"></div>
                            <span class="text-sm font-medium" id="connection-status">Ready</span>
                        </div>
                        <button id="clear-all-btn" class="btn-danger no-print">
                            <i class="fas fa-trash mr-1"></i>Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4">
        <div id="message-container" class="mb-6"></div>
        
        <!-- Main Input Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-search mr-2 text-blue-600"></i>Your Crawling Prompt</h2>
            <div class="mb-4">
                <textarea id="crawl-prompt" class="form-input" rows="3" placeholder="Enter a URL to crawl or describe what you want to find... e.g., 'https://example.com' or 'Find all news articles about AI from tech websites'"></textarea>
            </div>
            
            <!-- Quick Feature Toggles -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="feature-toggle-btn" data-feature="deep-crawl">
                    <i class="fas fa-project-diagram mr-1"></i>Deep Crawl
                </button>
                <button class="feature-toggle-btn" data-feature="pagination">
                    <i class="fas fa-list-ol mr-1"></i>Pagination
                </button>
                <button class="feature-toggle-btn" data-feature="ai-extraction">
                    <i class="fas fa-brain mr-1"></i>AI Extraction
                </button>
                <button class="feature-toggle-btn" data-feature="screenshot">
                    <i class="fas fa-camera mr-1"></i>Screenshot
                </button>
                <button class="feature-toggle-btn" data-feature="javascript">
                    <i class="fas fa-code mr-1"></i>JavaScript
                </button>
                <button class="feature-toggle-btn" data-feature="proxy">
                    <i class="fas fa-shield-alt mr-1"></i>Proxy
                </button>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="ai-discovery-toggle" class="mr-2 rounded">
                        <span class="text-sm">AI Discovery</span>
                    </label>
                </div>
                <button id="start-crawl-btn" class="btn-success"><i class="fas fa-play mr-2"></i>Start Crawling</button>
            </div>
        </div>
        
        <!-- Feature Configuration Accordion -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="border-b">
                <button class="w-full flex justify-between items-center p-4 text-left font-medium" id="features-accordion-btn">
                    <span><i class="fas fa-sliders-h mr-2"></i>Advanced Configuration</span>
                    <i class="fas fa-chevron-down transition-transform" id="accordion-icon"></i>
                </button>
            </div>
            <div class="p-4" id="features-accordion-content" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <!-- Crawl Strategy -->
                    <div class="border rounded-lg p-3">
                        <h3 class="font-medium mb-2">Crawl Strategy</h3>
                        <select id="crawl-strategy" class="form-select w-full">
                            <option value="basic">Basic Crawl</option>
                            <option value="smart">Smart Mode</option>
                            <option value="magic">Magic Mode</option>
                            <option value="comprehensive">Comprehensive</option>
                            <option value="adaptive">Adaptive Crawling</option>
                            <option value="deep">Deep Discovery</option>
                        </select>
                    </div>
                    
                    <!-- Extraction Strategy -->
                    <div class="border rounded-lg p-3">
                        <h3 class="font-medium mb-2">Extraction Strategy</h3>
                        <select id="extraction-strategy" class="form-select w-full">
                            <option value="css_selector">CSS Selector</option>
                            <option value="llm_based">LLM Based</option>
                            <option value="cosine">Cosine Strategy</option>
                        </select>
                    </div>
                    
                    <!-- Chunking Strategy -->
                    <div class="border rounded-lg p-3">
                        <h3 class="font-medium mb-2">Chunking Strategy</h3>
                        <select id="chunking-strategy" class="form-select w-full">
                            <option value="semantic">Semantic</option>
                            <option value="regex">Regex</option>
                        </select>
                    </div>
                    
                    <!-- Deep Crawl Settings -->
                    <div class="border rounded-lg p-3">
                        <h3 class="font-medium mb-2">Deep Crawl</h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="number" id="max-depth" class="form-input w-16 mr-2" value="3" min="1" max="10">
                                <span class="text-sm">Max Depth</span>
                            </label>
                            <label class="flex items-center">
                                <input type="number" id="max-urls" class="form-input w-16 mr-2" value="50" min="1">
                                <span class="text-sm">Max URLs</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Pagination Settings -->
                    <div class="border rounded-lg p-3">
                        <h3 class="font-medium mb-2">Pagination</h3>
                        <select id="pagination-strategy" class="form-select w-full">
                            <option value="auto">Auto Detect</option>
                            <option value="next-link">Next Link</option>
                            <option value="numbered">Numbered</option>
                            <option value="infinite-scroll">Infinite Scroll</option>
                            <option value="custom-selector">Custom Selector</option>
                        </select>
                    </div>
                    
                    <!-- AI Extraction Settings -->
                    <div class="border rounded-lg p-3">
                        <h3 class="font-medium mb-2">AI Extraction</h3>
                        <button id="ai-schema-btn" class="btn-secondary w-full text-sm">
                            <i class="fas fa-edit mr-1"></i>Schema
                        </button>
                    </div>
                </div>
                
                <!-- Manual Extraction -->
                <div class="border rounded-lg p-3 mt-4">
                    <h3 class="font-medium mb-2">Manual Extraction</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm mb-1">CSS Selector</label>
                            <input type="text" id="css-selector" class="form-input w-full" placeholder=".content, #main">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">XPath</label>
                            <input type="text" id="xpath-selector" class="form-input w-full" placeholder="//div[@class='content']">
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div class="border rounded-lg p-3 mt-4">
                    <h3 class="font-medium mb-2">Advanced Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm mb-1">Wait For Selector</label>
                            <input type="text" id="wait-for-selector" class="form-input w-full" placeholder=".content-loaded">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">User Agent</label>
                            <input type="text" id="user-agent" class="form-input w-full" placeholder="Mozilla/5.0...">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Proxy URL</label>
                            <input type="text" id="proxy-url" class="form-input w-full" placeholder="http://proxy:port">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Session ID</label>
                            <input type="text" id="session-id" class="form-input w-full" placeholder="session-123">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress Dashboard -->
        <div id="progress-dashboard" class="bg-white rounded-xl shadow-lg p-6 mb-6" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-chart-line mr-2 text-blue-600"></i>Progress Dashboard</h2>
            <div class="w-full bg-gray-200 rounded-full h-3 mb-4"><div id="progress-bar" class="progress-bar bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full" style="width: 0%"></div></div>
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-center mb-6">
                <div class="metric-card rounded-lg p-3"><div class="text-2xl font-bold text-blue-600" id="total-urls">0</div><div class="text-xs text-gray-600">Discovered</div></div>
                <div class="metric-card rounded-lg p-3"><div class="text-2xl font-bold text-green-600" id="completed-urls">0</div><div class="text-xs text-gray-600">Completed</div></div>
                <div class="metric-card rounded-lg p-3"><div class="text-2xl font-bold text-red-600" id="failed-urls">0</div><div class="text-xs text-gray-600">Failed</div></div>
                <div class="metric-card rounded-lg p-3"><div class="text-2xl font-bold text-yellow-600" id="blocks-encountered">0</div><div class="text-xs text-gray-600">Blocks</div></div>
                <div class="metric-card rounded-lg p-3"><div class="text-2xl font-bold text-indigo-600" id="current-speed">0</div><div class="text-xs text-gray-600">req/min</div></div>
                <div class="metric-card rounded-lg p-3"><div class="text-2xl font-bold text-purple-600" id="current-depth">0</div><div class="text-xs text-gray-600">Max Depth</div></div>
            </div>
            <div class="stats-chart"><canvas id="progressChart"></canvas></div>
            <div id="current-status" class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-600"><span class="text-sm text-gray-700" id="status-message">Ready to start crawling.</span></div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="bg-white rounded-xl shadow-lg p-6" style="display: none;">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-800"><i class="fas fa-list-alt mr-2 text-green-600"></i>Results</h2>
                <div class="flex items-center space-x-2">
                    <button id="download-json" class="btn-secondary text-sm"><i class="fas fa-download mr-1"></i>JSON</button>
                    <button id="download-csv" class="btn-secondary text-sm"><i class="fas fa-download mr-1"></i>CSV</button>
                </div>
            </div>
            <div id="results-container" class="results-container space-y-4">
                <div class="text-center text-gray-500 py-12"><div class="animate-bounce-slow"><i class="fas fa-search text-6xl mb-4 text-gray-300"></i></div><p>Start crawling to see results.</p></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- API Keys Modal -->
    <div id="api-keys-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">API Keys</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Groq API Key</label>
                    <input type="password" id="groq-api-key" class="form-input w-full" placeholder="gsk_...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">OpenAI API Key</label>
                    <input type="password" id="openai-api-key" class="form-input w-full" placeholder="sk-...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Anthropic API Key</label>
                    <input type="password" id="anthropic-api-key" class="form-input w-full" placeholder="sk-...">
                </div>
                <div class="flex justify-end space-x-2">
                    <button class="btn-secondary close-modal">Cancel</button>
                    <button id="save-api-keys" class="btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Settings</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Concurrent Requests</label>
                    <input type="number" id="concurrent-requests" class="form-input w-full" value="3" min="1" max="10">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Request Delay (ms)</label>
                    <input type="number" id="request-delay" class="form-input w-full" value="1000" min="0">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Timeout (s)</label>
                    <input type="number" id="timeout" class="form-input w-full" value="30" min="5">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Max Retries</label>
                    <input type="number" id="max-retries" class="form-input w-full" value="3" min="0">
                </div>
                <div class="flex justify-end space-x-2">
                    <button class="btn-secondary close-modal">Cancel</button>
                    <button id="save-settings" class="btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Schema Modal -->
    <div id="ai-schema-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">AI Extraction Schema</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Schema (JSON)</label>
                    <textarea id="ai-schema" class="form-input w-full" rows="6" placeholder='{"type": "object", "properties": {"title": {"type": "string"}, "content": {"type": "string"}}}'></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Instruction</label>
                    <textarea id="ai-instruction" class="form-input w-full" rows="3" placeholder="Extract the main content and title from the page"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button class="btn-secondary close-modal">Cancel</button>
                    <button id="save-ai-schema" class="btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* General Styling & Layout */
        .progress-bar { transition: width 0.3s ease; }
        
        /* Glassmorphism & Gradients */
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white; font-weight: 500; padding: 0.75rem 1rem;
            border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #6b7280; color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        .btn-danger { background: #ef4444; color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }
        .btn-success { background: #10b981; color: white; font-weight: 500; padding: 0.75rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        
        .feature-toggle-btn {
            background: #e5e7eb; color: #374151; font-weight: 500; padding: 0.25rem 0.5rem;
            border-radius: 0.375rem; border: 1px solid #d1d5db; cursor: pointer; transition: all 0.2s;
            font-size: 0.875rem;
        }
        .feature-toggle-btn:hover { background: #d1d5db; }
        .feature-toggle-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }

        /* Forms & Messages */
        .form-input, .form-select {
            width: 100%; padding: 0.5rem; border: 1px solid #d1d5db;
            border-radius: 0.375rem; outline: none; transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 0.875rem;
        }
        .form-input:focus, .form-select:focus {
            border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .message { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .message.success { background: #dcfce7; border: 1px solid #bbf7d0; color: #166534; }
        .message.error { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; }
        .message.warning { background: #fef3c7; border: 1px solid #fde68a; color: #92400e; }

        /* Cards & Sections */
        .crawl-card { 
            transition: all 0.3s ease; 
            page-break-inside: avoid;
        }
        .crawl-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
        }
        .crawl-card.success { border-left: 4px solid #10B981; }
        .crawl-card.failed { border-left: 4px solid #EF4444; }
        .crawl-card.blocked { border-left: 4px solid #F59E0B; }
        .crawl-card.processing { border-left: 4px solid #8B5CF6; }
        .crawl-card.discovered { border-left: 4px solid #3B82F6; }
        .metric-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        /* Animations */
        .pulse-ring { animation: pulse-ring 1.5s ease-out infinite; }
        @keyframes pulse-ring { 0% { transform: scale(.33); opacity: 1; } 80%, 100% { opacity: 0; transform: scale(1.5); } }
        .animate-bounce-slow { animation: bounce 2s infinite; }
        .stats-chart { height: 300px; margin-top: 1rem; }
        
        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; border-radius: 0.5rem; width: 90%; max-width: 600px; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: black; }
    </style>

    <script>
        /**
         * Crawl4AI Comprehensive Demo
         * A showcase of all Crawl4AI features with a clean, organized interface
         */
        class Crawl4AIDemo {
            constructor() {
                this.crawlResults = [];
                this.progressChart = null;
                this.activeFeatures = new Set();
                this.apiKeys = {
                    groq: '',
                    openai: '',
                    anthropic: ''
                };
                this.settings = {
                    concurrentRequests: 3,
                    requestDelay: 1000,
                    timeout: 30,
                    maxRetries: 3
                };
                this.aiSchema = {
                    schema: '',
                    instruction: ''
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializeChart();
                this.checkApiConnection();
                this.loadFromLocalStorage();
            }

            setupEventListeners() {
                // Main actions
                document.getElementById('start-crawl-btn').addEventListener('click', () => this.startCrawl());
                document.getElementById('clear-all-btn').addEventListener('click', () => this.clearAll());
                document.getElementById('download-json').addEventListener('click', () => this.downloadResults('json'));
                document.getElementById('download-csv').addEventListener('click', () => this.downloadResults('csv'));
                
                // Feature toggles
                document.querySelectorAll('.feature-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const feature = e.target.closest('.feature-toggle-btn').dataset.feature;
                        this.toggleFeature(feature);
                    });
                });
                
                // Accordion
                document.getElementById('features-accordion-btn').addEventListener('click', () => this.toggleAccordion());
                
                // Modals
                document.getElementById('api-keys-btn').addEventListener('click', () => this.openModal('api-keys-modal'));
                document.getElementById('settings-btn').addEventListener('click', () => this.openModal('settings-modal'));
                document.getElementById('ai-schema-btn').addEventListener('click', () => this.openModal('ai-schema-modal'));
                
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const modal = e.target.closest('.modal') || document.getElementById(e.target.closest('button').dataset.modal);
                        if (modal) this.closeModal(modal.id);
                    });
                });
                
                // Modal save buttons
                document.getElementById('save-api-keys').addEventListener('click', () => this.saveApiKeys());
                document.getElementById('save-settings').addEventListener('click', () => this.saveSettings());
                document.getElementById('save-ai-schema').addEventListener('click', () => this.saveAISchema());
                
                // Close modals when clicking outside
                window.addEventListener('click', (e) => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        if (e.target === modal) {
                            this.closeModal(modal.id);
                        }
                    });
                });
            }

            toggleFeature(feature) {
                const btn = document.querySelector(`[data-feature="${feature}"]`);
                if (this.activeFeatures.has(feature)) {
                    this.activeFeatures.delete(feature);
                    btn.classList.remove('active');
                } else {
                    this.activeFeatures.add(feature);
                    btn.classList.add('active');
                }
            }

            toggleAccordion() {
                const content = document.getElementById('features-accordion-content');
                const icon = document.getElementById('accordion-icon');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    content.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                }
            }

            openModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
            }

            closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            async checkApiConnection() {
                try {
                    const response = await fetch('http://localhost:8000/health');
                    const data = await response.json();
                    
                    if (data.status === 'healthy') {
                        document.getElementById('connection-status').innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>Connected';
                    } else {
                        throw new Error('Crawl4AI service not responding correctly');
                    }
                } catch (error) {
                    console.error('Crawl4AI connection error:', error);
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-exclamation-circle text-red-500 mr-1"></i>Disconnected';
                    this.showMessage('Error connecting to Crawl4AI service. Please make sure it is running on port 8000.', 'error');
                }
            }

            initializeChart() {
                const ctx = document.getElementById('progressChart').getContext('2d');
                if (this.progressChart) this.progressChart.destroy();
                this.progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Success',
                                data: [],
                                borderColor: '#10B981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.2,
                                fill: true
                            },
                            {
                                label: 'Failed',
                                data: [],
                                borderColor: '#EF4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.2,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            async startCrawl() {
                const prompt = document.getElementById('crawl-prompt').value.trim();
                if (!prompt) {
                    this.showMessage('Please enter a URL or crawling prompt.', 'warning');
                    return;
                }

                // Determine if it's a URL or a description
                const isUrl = prompt.startsWith('http://') || prompt.startsWith('https://');
                
                if (isUrl) {
                    this.showMessage('Starting crawl...', 'warning');
                    document.getElementById('start-crawl-btn').disabled = true;
                    document.getElementById('start-crawl-btn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Crawling...';
                    
                    try {
                        // Show progress dashboard
                        document.getElementById('progress-dashboard').style.display = 'block';
                        document.getElementById('results-section').style.display = 'block';
                        
                        // Prepare crawl configuration
                        const crawlConfig = {
                            url: prompt,
                            strategy: document.getElementById('crawl-strategy').value,
                            extraction_strategy: document.getElementById('extraction-strategy').value,
                            chunking_strategy: document.getElementById('chunking-strategy').value,
                            enable_pagination: this.activeFeatures.has('pagination'),
                            enable_deep_crawl: this.activeFeatures.has('deep-crawl'),
                            max_depth: parseInt(document.getElementById('max-depth').value) || 3,
                            max_urls: parseInt(document.getElementById('max-urls').value) || 50,
                            pagination_strategy: document.getElementById('pagination-strategy').value,
                            javascript_enabled: this.activeFeatures.has('javascript'),
                            screenshot: this.activeFeatures.has('screenshot')
                        };

                        // Add optional parameters
                        const waitForSelector = document.getElementById('wait-for-selector').value.trim();
                        if (waitForSelector) {
                            crawlConfig.wait_for_selector = waitForSelector;
                        }

                        const userAgent = document.getElementById('user-agent').value.trim();
                        if (userAgent) {
                            crawlConfig.user_agent = userAgent;
                        }

                        const proxyUrl = document.getElementById('proxy-url').value.trim();
                        if (proxyUrl) {
                            crawlConfig.proxy = proxyUrl;
                        }

                        const sessionId = document.getElementById('session-id').value.trim();
                        if (sessionId) {
                            crawlConfig.session_id = sessionId;
                        }

                        // Add CSS selector if provided
                        const cssSelector = document.getElementById('css-selector').value.trim();
                        if (cssSelector) {
                            crawlConfig.css_selector = cssSelector;
                        }

                        // Add XPath if provided
                        const xpathSelector = document.getElementById('xpath-selector').value.trim();
                        if (xpathSelector) {
                            crawlConfig.xpath_selector = xpathSelector;
                        }

                        // Add AI extraction if enabled
                        if (this.activeFeatures.has('ai-extraction')) {
                            crawlConfig.extraction_strategy = 'llm_based';
                            if (this.aiSchema.schema) {
                                try {
                                    crawlConfig.extraction_schema = {
                                        schema: JSON.parse(this.aiSchema.schema),
                                        instruction: this.aiSchema.instruction,
                                        api_key: this.apiKeys.groq || this.apiKeys.openai || this.apiKeys.anthropic
                                    };
                                } catch (e) {
                                    console.warn('Invalid AI schema JSON');
                                }
                            }
                        }

                        console.log('Sending crawl request:', crawlConfig);

                        // Send request to Crawl4AI service
                        const response = await fetch('http://localhost:8000/crawl', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(crawlConfig)
                        });

                        const data = await response.json();
                        console.log('Crawl response:', data);

                        if (response.ok && data.success) {
                            this.showMessage('Crawl completed successfully!', 'success');
                            this.displayCrawlResults([data]);
                        } else {
                            throw new Error(data.error || 'Crawl failed');
                        }
                    } catch (error) {
                        console.error('Crawl error:', error);
                        this.showMessage(`Crawl failed: ${error.message}`, 'error');
                    } finally {
                        document.getElementById('start-crawl-btn').disabled = false;
                        document.getElementById('start-crawl-btn').innerHTML = '<i class="fas fa-play mr-2"></i>Start Crawling';
                    }
                } else {
                    this.showMessage('AI discovery feature coming soon. For now, please enter a valid URL.', 'warning');
                }
            }

            displayCrawlResults(results) {
                this.crawlResults = results;
                const container = document.getElementById('results-container');
                container.innerHTML = '';

                results.forEach((result, index) => {
                    const card = document.createElement('div');
                    card.className = `crawl-card ${result.success ? 'success' : 'failed'} bg-white rounded-lg shadow p-4`;
                    
                    if (result.success) {
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-blue-700">${result.title || 'Untitled Page'}</p>
                                    <a href="${result.url}" target="_blank" class="text-xs text-gray-500 hover:underline">${this.truncateUrl(result.url, 70)}</a>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h3 class="font-medium text-gray-800 mb-2">Extracted Content</h3>
                                <div class="extraction-preview bg-gray-50 p-3 rounded max-h-40 overflow-y-auto text-sm">
                                    ${this.escapeHtml((result.markdown?.raw_markdown || result.markdown || '').substring(0, 500)) + ((result.markdown?.raw_markdown || result.markdown || '').length > 500 ? '...' : '')}
                                </div>
                            </div>
                            ${result.extracted_content ? `
                            <div class="mt-4">
                                <h3 class="font-medium text-gray-800 mb-2">Structured Data</h3>
                                <div class="extraction-preview bg-gray-50 p-3 rounded max-h-40 overflow-y-auto">
                                    <pre>${this.escapeHtml(JSON.stringify(result.extracted_content, null, 2))}</pre>
                                </div>
                            </div>
                            ` : ''}
                            ${result.links && result.links.length > 0 ? `
                            <div class="mt-4">
                                <h3 class="font-medium text-gray-800 mb-2">Links Found (${result.links.length})</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${result.links.slice(0, 5).map(link => `
                                        <a href="${link}" target="_blank" class="text-sm text-blue-600 hover:underline truncate">${this.escapeHtml(link)}</a>
                                    `).join('')}
                                    ${result.links.length > 5 ? `<span class="text-sm text-gray-500">+${result.links.length - 5} more</span>` : ''}
                                </div>
                            </div>
                            ` : ''}
                            ${result.media && result.media.length > 0 ? `
                            <div class="mt-4">
                                <h3 class="font-medium text-gray-800 mb-2">Media Found (${result.media.length})</h3>
                                <div class="flex flex-wrap gap-2">
                                    ${result.media.slice(0, 3).map(media => `
                                        <a href="${media}" target="_blank" class="text-sm text-blue-600 hover:underline truncate">${this.escapeHtml(media)}</a>
                                    `).join('')}
                                    ${result.media.length > 3 ? `<span class="text-sm text-gray-500">+${result.media.length - 3} more</span>` : ''}
                                </div>
                            </div>
                            ` : ''}
                            ${result.screenshot_url ? `
                            <div class="mt-4">
                                <h3 class="font-medium text-gray-800 mb-2">Screenshot</h3>
                                <img src="${result.screenshot_url}" alt="Page screenshot" class="max-w-full h-auto rounded">
                            </div>
                            ` : ''}
                        `;
                    } else {
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-red-700">Crawl Failed</p>
                                    <a href="${result.url}" target="_blank" class="text-xs text-gray-500 hover:underline">${this.truncateUrl(result.url, 70)}</a>
                                </div>
                            </div>
                            <div class="mt-2 text-red-600">
                                <p><strong>Error:</strong> ${this.escapeHtml(result.error || 'Unknown error')}</p>
                            </div>
                        `;
                    }
                    
                    container.appendChild(card);
                });
            }

            truncateUrl(url, len = 60) {
                return url.length > len ? url.slice(0, len) + '...' : url;
            }

            escapeHtml(unsafe) {
                return unsafe?.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") || '';
            }

            showMessage(message, type) {
                const container = document.getElementById('message-container');
                const div = document.createElement('div');
                div.className = `message ${type} flex justify-between items-center`;
                div.innerHTML = `<span>${message}</span><button class="font-bold" onclick="this.parentElement.remove()">&times;</button>`;
                container.appendChild(div);
                setTimeout(() => div.remove(), 5000);
            }

            clearAll() {
                if (confirm('Are you sure you want to clear all data?')) {
                    document.getElementById('crawl-prompt').value = '';
                    document.getElementById('results-container').innerHTML = '<div class="text-center text-gray-500 py-12"><div class="animate-bounce-slow"><i class="fas fa-search text-6xl mb-4 text-gray-300"></i></div><p>All data cleared.</p></div>';
                    
                    // Reset stats
                    document.getElementById('total-urls').textContent = '0';
                    document.getElementById('completed-urls').textContent = '0';
                    document.getElementById('failed-urls').textContent = '0';
                    document.getElementById('blocks-encountered').textContent = '0';
                    document.getElementById('current-speed').textContent = '0';
                    document.getElementById('current-depth').textContent = '0';
                    document.getElementById('progress-bar').style.width = '0%';
                    document.getElementById('status-message').textContent = 'All data cleared.';
                    
                    // Reset UI sections
                    document.getElementById('progress-dashboard').style.display = 'none';
                    document.getElementById('results-section').style.display = 'none';
                    
                    this.initializeChart();
                    this.showMessage('All data cleared.', 'success');
                }
            }

            downloadResults(format) {
                if (this.crawlResults.length === 0) {
                    this.showMessage('No results to download.', 'warning');
                    return;
                }

                if (format === 'json') {
                    const dataStr = JSON.stringify(this.crawlResults, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'crawl-results.json';
                    link.click();
                    URL.revokeObjectURL(url);
                    this.showMessage('Results downloaded as JSON.', 'success');
                } else if (format === 'csv') {
                    // Simple CSV conversion
                    let csvContent = 'URL,Title,Status,Error,Response Time (ms)\n';
                    this.crawlResults.forEach(result => {
                        const responseTime = result.performance_metrics ? result.performance_metrics.response_time : '';
                        csvContent += `"${result.url}","${result.title || ''}","${result.success ? 'Success' : 'Failed'}","${result.error || ''}","${responseTime}"\n`;
                    });
                    const dataBlob = new Blob([csvContent], {type: 'text/csv'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'crawl-results.csv';
                    link.click();
                    URL.revokeObjectURL(url);
                    this.showMessage('Results downloaded as CSV.', 'success');
                }
            }

            saveApiKeys() {
                this.apiKeys.groq = document.getElementById('groq-api-key').value;
                this.apiKeys.openai = document.getElementById('openai-api-key').value;
                this.apiKeys.anthropic = document.getElementById('anthropic-api-key').value;
                this.saveToLocalStorage();
                this.closeModal('api-keys-modal');
                this.showMessage('API keys saved.', 'success');
            }

            saveSettings() {
                this.settings.concurrentRequests = parseInt(document.getElementById('concurrent-requests').value);
                this.settings.requestDelay = parseInt(document.getElementById('request-delay').value);
                this.settings.timeout = parseInt(document.getElementById('timeout').value);
                this.settings.maxRetries = parseInt(document.getElementById('max-retries').value);
                this.saveToLocalStorage();
                this.closeModal('settings-modal');
                this.showMessage('Settings saved.', 'success');
            }

            saveAISchema() {
                this.aiSchema.schema = document.getElementById('ai-schema').value;
                this.aiSchema.instruction = document.getElementById('ai-instruction').value;
                this.saveToLocalStorage();
                this.closeModal('ai-schema-modal');
                this.showMessage('AI schema saved.', 'success');
            }

            saveToLocalStorage() {
                localStorage.setItem('crawl4ai-apikeys', JSON.stringify(this.apiKeys));
                localStorage.setItem('crawl4ai-settings', JSON.stringify(this.settings));
                localStorage.setItem('crawl4ai-aischema', JSON.stringify(this.aiSchema));
            }

            loadFromLocalStorage() {
                const apiKeys = localStorage.getItem('crawl4ai-apikeys');
                if (apiKeys) {
                    this.apiKeys = JSON.parse(apiKeys);
                    document.getElementById('groq-api-key').value = this.apiKeys.groq;
                    document.getElementById('openai-api-key').value = this.apiKeys.openai;
                    document.getElementById('anthropic-api-key').value = this.apiKeys.anthropic;
                }

                const settings = localStorage.getItem('crawl4ai-settings');
                if (settings) {
                    this.settings = JSON.parse(settings);
                    document.getElementById('concurrent-requests').value = this.settings.concurrentRequests;
                    document.getElementById('request-delay').value = this.settings.requestDelay;
                    document.getElementById('timeout').value = this.settings.timeout;
                    document.getElementById('max-retries').value = this.settings.maxRetries;
                }

                const aiSchema = localStorage.getItem('crawl4ai-aischema');
                if (aiSchema) {
                    this.aiSchema = JSON.parse(aiSchema);
                    document.getElementById('ai-schema').value = this.aiSchema.schema;
                    document.getElementById('ai-instruction').value = this.aiSchema.instruction;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new Crawl4AIDemo();
        });
    </script>
</body>
</html>